 
# This workflow will build a package using Maven and then publish it to GitHub packages when a release is created
# For more information see: https://github.com/actions/setup-java/blob/main/docs/advanced-usage.md#apache-maven-with-a-settings-path

name: Make release

on:
  release:
    types: [created]

  workflow_dispatch:

env:
  VERSION: ${{ github.ref_name }}
  # Used to skip publishing, when testing via workflow_dispatch
  IS_RELEASE: ${{ github.event == 'release'}}
  # Used to skip setting the version, when testing the workflow on a branch
  IS_TAG: ${{ github.ref_type == 'tag' }}

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Java for publishing to Maven Central Repository
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
      - name: Maven change version
        if: env.IS_TAG == 'true'
        run: mvn versions:set -DnewVersion=${VERSION} --batch-mode
      - name: Maven change serializer version
        if: env.IS_TAG == 'true'
        run:  mvn versions:set-property -Dproperty=eclipse.serializer.version -DnewVersion=${VERSION}
      - name: Make a release
        run: |
          echo "Deploying version: ${VERSION}"
          opts="-Pdeploy -Pproduction --no-transfer-progress --batch-mode"

          if [ ${IS_RELEASE} == 'false' ]; then
            echo "NOTE: Publishing and signing skipped"
            opts="${opts} -DskipPublishing=true -Dgpg.skip"
          fi

          eval "mvn ${opts} clean deploy"

        env:
          MAVEN_USERNAME: ${{ secrets.CENTRAL_SONATYPE_TOKEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.CENTRAL_SONATYPE_TOKEN_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.ORG_GPG_PASSPHRASE }}
          MAVEN_GPG_KEY: ${{ secrets.ORG_GPG_PRIVATE_KEY }}
      - name: Upload SBOM
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: sbom
          path: target/sbom/Eclipse-Store-Sbom.json

  store-sbom-data: # stores sbom and metadata in a predefined format for otterdog to pick up
    needs: ['publish']
    uses: eclipse-csi/workflows/.github/workflows/store-sbom-data.yml@main
    with:
      projectName: 'store'
      # Cannot use env.VERSION (see see actions/runner#2372)
      projectVersion: ${{ github.ref_name }}
      bomArtifact: 'sbom'
      bomFilename: 'Eclipse-Store-Sbom.json'
      parentProject: '0a48ad69-bb92-4881-b35e-450e4f7264dc'
